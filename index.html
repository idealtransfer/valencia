<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Valencia</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --btn-color: var(--tg-theme-button-color, #248bed);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
        }
        body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: var(--hint-color); }
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #ccc; 
            border-radius: 10px; background: var(--bg-color); color: var(--text-color);
            box-sizing: border-box; font-size: 16px;
        }
        .row { display: flex; gap: 10px; flex-wrap: wrap; }
        .row > div { flex: 1; min-width: 140px; }
        
        button#order-btn { 
            width: 100%; padding: 16px; background: var(--btn-color); 
            color: var(--btn-text); border: none; border-radius: 12px; 
            font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 20px;
        }
        h3 { margin-top: 0; text-align: center; }
        #success-screen { text-align: center; padding: 40px 20px; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="form-container">
        <h3 id="ui-title">Ваш идеальный трансфер в Валенсии</h3>
        
        <div class="form-group"><label id="lbl-pickup">Откуда</label><input type="text" id="pickup"></div>
        <div class="form-group"><label id="lbl-dest">Куда</label><input type="text" id="destination"></div>
        <div class="row">
            <div class="form-group"><label id="lbl-date">Дата</label><input type="date" id="date"></div>
            <div class="form-group"><label id="lbl-time">Время</label><input type="time" id="time"></div>
        </div>
        <div class="form-group"><label id="lbl-flight">Номер рейса</label><input type="text" id="flight"></div>
        <div class="row">
            <div class="form-group"><label id="lbl-adults">Взрослые</label><input type="number" id="adults" value="1"></div>
            <div class="form-group"><label id="lbl-luggage">Чемоданы</label><input type="number" id="luggage"></div>
        </div>
        <div class="row">
             <div class="form-group"><label id="lbl-booster">Бустер</label><input type="number" id="booster"></div>
             <div class="form-group"><label id="lbl-child-seat">Дет. кресло</label><input type="number" id="child_seat"></div>
        </div>
        <div class="form-group">
            <label id="lbl-pay">Оплата</label>
            <select id="payment">
                <option value="cash" id="opt-cash">Наличные</option>
                <option value="card">Visa/MasterCard</option>
                <option value="usdt">USDT</option>
            </select>
        </div>
        <div class="form-group"><label id="lbl-comments">Пожелания</label><input type="text" id="comments"></div>
        <div class="row">
            <div class="form-group"><label id="lbl-name">Имя</label><input type="text" id="user_name"></div>
            <div class="form-group"><label id="lbl-phone">Телефон</label><input type="tel" id="user_phone" value="+34"></div>
        </div>
        <div class="form-group">
            <label id="lbl-contact-method">Связь</label>
            <select id="contact_method">
                <option value="Telegram">Telegram</option>
                <option value="WhatsApp">WhatsApp</option>
            </select>
        </div>

        <button id="order-btn">Отправить заявку</button>
    </div>

    <div id="success-screen">
        <div style="font-size: 60px;">✅</div>
        <h2 id="success-title">Заявка принята!</h2>
        <p>Мы свяжемся с вами в ближайшее время.</p>
        <br>
        <button onclick="Telegram.WebApp.close()" style="padding: 12px 24px; background: #ddd; border: none; border-radius: 8px;">Закрыть</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Простой перевод интерфейса
        const translations = {
            ru: { title: "Ваш идеальный трансфер", pickup: "Откуда", dest: "Куда", order: "Отправить заявку" },
            en: { title: "Your ideal transfer", pickup: "From", dest: "To", order: "Send Request" }
        };
        const lang = translations[tg.initDataUnsafe?.user?.language_code] || translations.ru;
        document.getElementById('ui-title').innerText = lang.title;

        document.getElementById('order-btn').addEventListener('click', function() {
            // 1. Собираем данные
            const data = {
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                flight: document.getElementById('flight').value,
                adults: document.getElementById('adults').value,
                booster: document.getElementById('booster').value,
                child_seat: document.getElementById('child_seat').value,
                luggage: document.getElementById('luggage').value,
                payment: document.getElementById('payment').value,
                comments: document.getElementById('comments').value,
                name: document.getElementById('user_name').value,
                phone: document.getElementById('user_phone').value,
                contact_method: document.getElementById('contact_method').value,
                // Добавляем ID пользователя, чтобы бот мог ему ответить
                user_id: tg.initDataUnsafe?.user?.id 
            };

            if(!data.pickup || !data.destination || !data.name) {
                tg.showAlert("Заполните основные поля (Откуда, Куда, Имя)");
                return;
            }
            
            // Визуально показываем "Загрузку"
            const btn = document.getElementById('order-btn');
            btn.innerText = "Отправка...";
            btn.disabled = true;

            // 2. ОТПРАВЛЯЕМ НА СЕРВЕР (POST запрос)
            fetch('/submit_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    // 3. Успех
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('success-screen').style.display = 'block';
                } else {
                    tg.showAlert("Ошибка сервера. Попробуйте еще раз.");
                    btn.innerText = "Отправить заявку";
                    btn.disabled = false;
                }
            })
            .catch(error => {
                tg.showAlert("Ошибка сети: " + error);
                btn.innerText = "Отправить заявку";
                btn.disabled = false;
            });
        });
    </script>
</body>
</html>
